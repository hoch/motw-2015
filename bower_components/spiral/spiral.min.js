!function(window){"use strict";var hasWebKitAudioContext=(function(){var tem,ua=navigator.userAgent,M=ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(M[1])?(tem=/\brv[ :]+(\d+)/g.exec(ua)||[],"IE "+(tem[1]||"")):"Chrome"===M[1]&&(tem=ua.match(/\bOPR\/(\d+)/),null!==tem)?"Opera "+tem[1]:(M=M[2]?[M[1],M[2]]:[navigator.appName,navigator.appVersion,"-?"],null!==(tem=ua.match(/version\/(\d+)/i))&&M.splice(1,1,tem[1]),M.join(" "))}(),window.hasOwnProperty("webkitAudioContext")),hasAudioContext=window.hasOwnProperty("AudioContext");if(!hasWebKitAudioContext&&!hasAudioContext)return console.log("[Spiral] This browser does not support Web Audio API."),void(window._SPIRALFATAL=!0);hasWebKitAudioContext&&!hasAudioContext&&(window.AudioContext=window.webkitAudioContext,console.log("[Spiral] This browser still has webkitAudioContext. Patch applied."));var DEPRECATED_DICT={AudioContext:{createDelayNode:"createDelay",createGainNode:"createGain",createJavaScriptNode:"createScriptProcessor",createWaveTable:"createPeriodicWave"},AudioParam:{setTargetValueAtTime:"setTargetAtTime"},OscillatorNode:{noteOn:"start",noteOff:"stop",setWaveTable:"setPeriodicWave"},AudioBufferSourceNode:{noteOn:"start",noteOff:"stop"}};for(var nameSpace in DEPRECATED_DICT){var newMethods=DEPRECATED_DICT[nameSpace];for(var oldMethod in newMethods)window[nameSpace].prototype[oldMethod]=window[nameSpace].prototype[newMethods[oldMethod]]}}(window);
!function(){"use strict";function _loadAudioFile(context,fileInfo,done){var xhr=new XMLHttpRequest;xhr.open("GET",fileInfo.url),xhr.responseType="arraybuffer",xhr.onload=function(){200===xhr.status?context.decodeAudioData(xhr.response,function(buffer){done(fileInfo.name,buffer)},function(message){console.log("[Spiral] Decoding failure: "+fileInfo.url+" ("+message+")"),done(fileInfo.name,null)}):(console.log("[Spiral] XHR Error: "+fileInfo.url+" ("+xhr.statusText+")"),done(fileInfo.name,null))},xhr.onerror=function(event){console.log("[Spiral] XHR Network failure: "+fileInfo.url),done(fileInfo.name,null)},xhr.send()}function AudioBufferManager(context,audioFileData,resolve,reject,progress){this._context=context,this._resolve=resolve,this._reject=reject,this._progress=progress,this._buffers=new Map,this._loadingTasks={};for(var i=0;i<audioFileData.length;i++){var fileInfo=audioFileData[i];if(this._loadingTasks.hasOwnProperty(fileInfo.name))return console.log("[Spiral] Duplicated filename in AudioBufferManager: "+fileInfo.name),void reject(null);this._loadingTasks[fileInfo.name]=0,_loadAudioFile(this._context,fileInfo,this._done.bind(this))}}window.Spiral=new Object;var SPIRAL_VERSION="0.0.2",EPSILON=.001;AudioBufferManager.prototype._done=function(filename,buffer){this._loadingTasks[filename]=null!==buffer?1:2,this._buffers.set(filename,buffer),this._updateProgress(filename)},AudioBufferManager.prototype._updateProgress=function(filename){var numberOfFinishedTasks=0,numberOfFailedTask=0,numberOfTasks=0;for(var task in this._loadingTasks)numberOfTasks++,1===this._loadingTasks[task]?numberOfFinishedTasks++:2===this._loadingTasks[task]&&numberOfFailedTask++;this._progress(filename,numberOfFinishedTasks,numberOfTasks),numberOfFinishedTasks===numberOfTasks&&this._resolve(this._buffers),numberOfFinishedTasks+numberOfFailedTask===numberOfTasks&&this._reject(this._buffers)},Object.defineProperties(window.AudioContext.prototype,{now:{get:function(){return this.currentTime}},DAC:{get:function(){return this.destination}},loadAudioFiles:{value:function(dataModel,onprogress){return new Promise(function(resolve,reject){new AudioBufferManager(this,dataModel,resolve,reject,onprogress)}.bind(this))}},createNodes:{value:function(target,nodeList){if("object"!=typeof target)throw"[Spiral] Creation target is not an object.";for(var name in nodeList){var functionName="create"+nodeList[name];if("function"!=typeof this[functionName])throw"[Spiral] Invalid AudioNode constructor: "+functionName;target[name]=this[functionName]()}}}}),Object.defineProperties(window.AudioNode.prototype,{to:{value:function(){if(arguments.length>0){for(var i=0;i<arguments.length;i++)this.connect(arguments[i]);return arguments[0]}return this}},cut:{value:function(){this.disconnect()}}}),Object.defineProperties(window.AudioParam.prototype,{step:{value:function(){if(arguments[0]instanceof Array)for(var i=0;i<arguments.length;i++)this.setValueAtTime.apply(this,arguments[i]);else this.setValueAtTime.apply(this,arguments);return this}},line:{value:function(){if(arguments[0]instanceof Array)for(var i=0;i<arguments.length;i++)this.linearRampToValueAtTime.apply(this,arguments[i]);else this.linearRampToValueAtTime.apply(this,arguments);return this}},expo:{value:function(){if(arguments[0]instanceof Array)for(var i=0;i<arguments.length;i++)this.exponentialRampToValueAtTime.apply(this,arguments[i]);else this.exponentialRampToValueAtTime.apply(this,arguments);return this}},slew:{value:function(targetValue,startTime,duration){var safeTargetValue=Math.max(EPSILON,targetValue),tau=duration/Math.log(1/safeTargetValue);return this.setTargetAtTime(safeTargetValue,startTime,tau),this.setValueAtTime(safeTargetValue,startTime+duration),this.linearRampToValueAtTime(targetValue,startTime+duration),this}}}),Object.defineProperties(window.Spiral,{version:{get:function(){return SPIRAL_VERSION}},generateUid:{value:function(){return"yxxxxxxx".replace(/[xy]/g,function(c){var r=8*Math.random()|0,v="x"==c?r:3&r|8;return v.toString(16)})}}})}();
!function(Spiral){"use strict";function SpiralEnvelope(){this._points=new Map}SpiralEnvelope.prototype.get=function(){var times=[],envelope=[];this._points.keys.forEach(function(key){times.push(key)}),times.sort();for(var i=0;i<times.length;i++)envelope.push([this._points.get(times[i]),times[i]]);return envelope},SpiralEnvelope.prototype.set=function(){for(var i=0;i<arguments.length;i++)this._points.set(arguments[i][1],arguments[i][0])},Object.defineProperties(Spiral,{clamp:{value:function(value,min,max){return Math.min(Math.max(value,min),max)}},random2f:{value:function(min,max){return min+Math.random()*(max-min)}},random2:{value:function(min,max){return Math.round(min+Math.random()*(max-min))}},mtof:{value:function(midi){return-1500>=midi?0:midi>1499?3.282417553401589e38:440*Math.pow(2,(Math.floor(midi)-69)/12)}},ftom:{value:function(freq){return Math.floor(freq>0?Math.log(freq/440)/Math.LN2*12+69:-1500)}},powtodb:{value:function(power){if(0>=power)return 0;var db=100+10/Math.LN10*Math.log(power);return 0>db?0:db}},dbtopow:{value:function(db){return 0>=db?0:(db>870&&(db=870),Math.exp(.1*Math.LN10*(db-100)))}},rmstodb:{value:function(rms){if(0>=rms)return 0;var db=100+20/Math.LN10*Math.log(rms);return 0>db?0:db}},dbtorms:{value:function(db){return 0>=db?0:(db>485&&(db=485),Math.exp(.05*Math.LN10*(db-100)))}},lintodb:{value:function(lin){return 20*(lin>1e-5?Math.log(lin)/Math.LN10:-5)}},dbtolin:{value:function(db){return Math.pow(10,db/20)}},veltoamp:{value:function(velocity){return velocity/127}},createEnvelope:{value:function(){var envelope=new SpiralEnvelope;return envelope.set.apply(envelope,arguments),envelope}}})}(window.Spiral);
!function(Spiral){"use strict";function SpiralMIDISource(midiInput){this.targets=new Set,this.input=midiInput,this.input.onmidimessage=this.routeMIDIMessage.bind(this)}function SpiralMIDIManager(){this.sources=new Map,this.targets=new Map,this.isReady=!1,this.onReadyCallback=null}Spiral.MIDI={isSupported:!1};var _MIDIObject=function(type,channel,data1,data2){return{type:type,channel:channel,data1:data1,data2:data2}},_parseMIDIMessage=function(message){var channel=(15&message.data[0])+1;switch(message.data[0]>>4){case 8:return _MIDIObject("noteoff",channel,message.data[1],message.data[2]);case 9:return _MIDIObject("noteon",channel,message.data[1],message.data[2]);case 10:return _MIDIObject("polypressure",channel,message.data[1],message.data[2]);case 11:return _MIDIObject("controlchange",channel,message.data[1],message.data[2]);case 12:return _MIDIObject("programchange",channel,message.data[1],null);case 13:return _MIDIObject("channelpressure",channel,message.data[1],null);case 14:return _MIDIObject("pitchwheel",channel,message.data[1]<<8||message.data[2]);default:return null}};SpiralMIDISource.prototype.addTargets=function(){for(var i=0;i<arguments.length;i++){var targetObj=arguments[i];if(this.targets.has(targetObj))return void console.log("[Spiral:MIDI] Cannot add a duplicate MIDI target: "+targetObj);this.targets.add(targetObj)}},SpiralMIDISource.prototype.removeTargets=function(){for(var i=0;i<arguments.length;i++){var targetObj=arguments[i];if(!this.targets.has(targetObj))return void console.log("[Spiral:MIDI] Target is not available for removal: "+targetObj);this.targets["delete"](targetObj)}},SpiralMIDISource.prototype.routeMIDIMessage=function(message){if(0!==this.targets.size){var parsedMessage=_parseMIDIMessage(message);this.targets.forEach(function(target){target.onmidimessage(parsedMessage)})}},SpiralMIDIManager.prototype.start=function(){var me=this,promiseHandlers=function(resolve,reject){Spiral.MIDI.isSupported||reject("[Spiral.MIDI] Cannot proceed: Web MIDI API is not supported."),window.navigator.requestMIDIAccess().then(function(access){access.inputs.forEach(function(input){me.sources.has(input.name)||me.sources.set(input.name,new SpiralMIDISource(input))}),access.outputs.forEach(function(output){me.targets.has(output.name)||me.targets.set(output.name,output)}),me.isReady=!0,window.dispatchEvent(new Event("spiral-midi-ready",{detail:null})),resolve(me)},function(errorMessage){reject("[Spiral.MIDI] starting MIDI system failed: "+errorMEssage)})};return new Promise(promiseHandlers)},SpiralMIDIManager.prototype.stop=function(){},SpiralMIDIManager.prototype.report=function(){var sources=[],targets=[];return this.sources.forEach(function(source,label){sources.push(label)}),this.targets.forEach(function(target,label){targets.push(label)}),{sources:sources,targets:targets}},SpiralMIDIManager.prototype.defineTarget=function(label,target){return"string"!=typeof label?void console.log("[Spiral:MIDI] Target label should be a string."):this.targets.has(label)?void console.log("[Spiral:MIDI] Duplicate MIDI target label."):"function"!=typeof target.onmidimessage?void console.log("[Spiral:MIDI] MIDI target MUST have a valid onmidimessage handler."):void this.targets.set(label,target)},SpiralMIDIManager.prototype.connect=function(){for(var selectedSources=[],selectedTargets=[],me=this,tailFunction={to:function(){for(var i=0;i<arguments.length;i++){var targetLabel=arguments[i];if(!me.targets.has(targetLabel))return void console.log("[Spiral:MIDI] Cannot route invalid targets: "+targetLabel);selectedTargets.push(me.targets.get(targetLabel))}if(0===selectedTargets.length)return void console.log("[Spiral:MIDI] There is no target to route.");for(i=0;i<selectedSources.length;i++)selectedSources[i].addTargets.apply(selectedSources[i],selectedTargets)}},i=0;i<arguments.length;i++){var sourceLabel=arguments[i];me.sources.has(sourceLabel)?selectedSources.push(me.sources.get(sourceLabel)):console.log('[Spiral:MIDI] Cannot route invalid source: "'+sourceLabel+'"')}return 0===selectedSources.length?(console.log("[Spiral:MIDI] There is no source to route."),tailFunction):tailFunction},SpiralMIDIManager.prototype.connectAll=function(){var selectedTargets=[],me=this;return{to:function(){for(var i=0;i<arguments.length;i++){var targetLabel=arguments[i];if(!me.targets.has(targetLabel))return void console.log("[Spiral:MIDI] Cannot route invalid targets: "+targetLabel);selectedTargets.push(me.targets.get(targetLabel))}return 0===selectedTargets.length?void console.log("[Spiral:MIDI] There is no target to route."):void me.sources.forEach(function(source){source.addTargets.apply(source,selectedTargets)})}}},"function"==typeof window.navigator.requestMIDIAccess&&(Spiral.MIDI.isSupported=!0),Object.defineProperties(Spiral,{createMIDIManager:{value:function(){return new SpiralMIDIManager}},parseMIDIMessage:{value:_parseMIDIMessage}})}(window.Spiral);